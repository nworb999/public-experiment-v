<!DOCTYPE html>
<html>
<head>
    <title>Psyche Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .agents-panel {
            width: 30%;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .agent-container {
            flex: 1;
            padding: 20px;
            border-bottom: 1px solid #eee;
            overflow-y: auto;
        }
        .conversation-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background-color: #fff;
            margin-left: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .header {
            background-color: #4a86e8;
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .system-message {
            background-color: #f1f1f1;
            color: #666;
        }
        .agent1-message {
            background-color: #e3f2fd;
            align-self: flex-start;
        }
        .agent2-message {
            background-color: #fce4ec;
            align-self: flex-end;
        }
        .error-message {
            background-color: #ffebee;
            color: #c62828;
        }
        .metadata {
            margin-top: 10px;
            font-size: 0.9em;
        }
        .memory-item {
            margin: 5px 0;
            padding: 5px;
            background-color: #f5f5f5;
            border-radius: 3px;
        }
        .pipeline-stage {
            margin: 5px 0;
            padding: 5px;
            background-color: #f0f8ff;
            border-radius: 3px;
            border-left: 3px solid #4a86e8;
        }
        .status-container {
            padding: 10px;
            background-color: #e8f5e9;
            margin-bottom: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Psyche Visualizer</h1>
    </div>
    
    <div class="container">
        <div class="agents-panel">
            <div class="agent-container" id="agent1">
                <h2>Agent 1</h2>
                <div class="status-container">
                    <div><strong>Name:</strong> <span id="agent1-name">Loading...</span></div>
                    <div><strong>Personality:</strong> <span id="agent1-personality">Loading...</span></div>
                    <div><strong>Tension:</strong> <span id="agent1-tension">0</span>/100</div>
                </div>
                <h3>Pipeline Stages</h3>
                <div id="agent1-pipeline"></div>
                <h3>Memories</h3>
                <div id="agent1-memories"></div>
            </div>
            <div class="agent-container" id="agent2">
                <h2>Agent 2</h2>
                <div class="status-container">
                    <div><strong>Name:</strong> <span id="agent2-name">Loading...</span></div>
                    <div><strong>Personality:</strong> <span id="agent2-personality">Loading...</span></div>
                    <div><strong>Tension:</strong> <span id="agent2-tension">0</span>/100</div>
                </div>
                <h3>Pipeline Stages</h3>
                <div id="agent2-pipeline"></div>
                <h3>Memories</h3>
                <div id="agent2-memories"></div>
            </div>
        </div>
        <div class="conversation-panel" id="conversation">
            <div class="status-container" id="connection-status">
                Connecting to server...
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        
        // Connection established handler
        socket.on('connect', function() {
            $('#connection-status').html('Connected to server successfully!');
            $('#connection-status').css('background-color', '#e8f5e9');
        });
        
        // Connection error handler
        socket.on('connect_error', function() {
            $('#connection-status').html('Connection error! Please check if the server is running.');
            $('#connection-status').css('background-color', '#ffebee');
        });

        // Fetch initial configuration
        socket.emit('get_config');
        
        // Handle configuration data
        socket.on('config', function(data) {
            console.log('Received config:', data);
        });
        
        // Handle messages
        socket.on('add_message', function(data) {
            let messageClass = 'system-message';
            if (data.sender === 'Error') {
                messageClass = 'error-message';
            } else if (data.sender_id === 0) {
                messageClass = 'agent1-message';
            } else if (data.sender_id === 1) {
                messageClass = 'agent2-message';
            }
            
            $('#conversation').append(
                `<div class="message ${messageClass}">
                    <strong>${data.sender}:</strong>
                    <div>${data.message}</div>
                </div>`
            );
            
            // Auto-scroll to the latest message
            $('#conversation').scrollTop($('#conversation')[0].scrollHeight);
        });
        
        // Handle agent updates
        socket.on('update_agent1', function(data) {
            updateAgentUI(1, data);
        });
        
        socket.on('update_agent2', function(data) {
            updateAgentUI(2, data);
        });
        
        // Handle pipeline updates
        socket.on('pipeline_update', function(data) {
            const agentId = data.agent_id + 1;
            const pipelineDiv = $(`#agent${agentId}-pipeline`);
            
            // Clear previous pipeline data if this is the first stage
            if (data.stage === 'observe') {
                pipelineDiv.html('');
            }
            
            // Add this stage
            const stageHtml = `
                <div class="pipeline-stage">
                    <strong>${data.stage}:</strong>
                    <pre>${JSON.stringify(data.data, null, 2)}</pre>
                </div>
            `;
            pipelineDiv.append(stageHtml);
            
            // Auto-scroll the pipeline
            pipelineDiv.scrollTop(pipelineDiv[0].scrollHeight);
        });
        
        // Helper function to update agent UI
        function updateAgentUI(agentNum, data) {
            $(`#agent${agentNum}-name`).text(data.name);
            $(`#agent${agentNum}-personality`).text(data.personality);
            $(`#agent${agentNum}-tension`).text(data.tension);
            
            // Update memories
            const memoriesDiv = $(`#agent${agentNum}-memories`);
            memoriesDiv.html(''); // Clear previous memories
            
            if (data.memories && data.memories.length > 0) {
                data.memories.forEach(memory => {
                    memoriesDiv.append(`<div class="memory-item">${memory}</div>`);
                });
            } else {
                memoriesDiv.append('<div>No memories yet</div>');
            }
        }
    </script>
</body>
</html>
        