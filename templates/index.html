<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Conversation</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="page-container">
        <div class="column left-column">
            <div class="container">
                <div class="background">
                    <div class="ellipse ellipse-1"></div>
                    <div class="ellipse ellipse-2"></div>
                    <div class="ellipse ellipse-3"></div>
                </div>
                <div class="content">
                    <div class="conversation-flow">
                        <div class="conversation-column">
                            <h2 class="title-text">Prompts</h2>
                            <div class="boxes-stack">
                                <div class="box-container">
                                    <div class="prompt-title" id="prompt-title-1">Step: --</div>
                                    <div class="box">
                                        <div class="prompt-text" id="prompt-box-1"></div>
                                    </div>
                                </div>
                                <div class="box-container">
                                    <div class="prompt-title" id="prompt-title-2">Step: --</div>
                                    <div class="box">
                                        <div class="prompt-text" id="prompt-box-2"></div>
                                    </div>
                                </div>
                                <div class="box-container">
                                    <div class="prompt-title" id="prompt-title-3">Step: --</div>
                                    <div class="box">
                                        <div class="prompt-text" id="prompt-box-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="conversation-column">
                            <h2 class="title-text">Responses</h2>
                            <div class="boxes-stack">
                                <div class="box-container">
                                    <div class="time-elapsed" id="response-time-1">Time elapsed: --</div>
                                    <div class="box">
                                        <div class="response-text" id="response-box-1"></div>
                                    </div>
                                </div>
                                <div class="box-container">
                                    <div class="time-elapsed" id="response-time-2">Time elapsed: --</div>
                                    <div class="box">
                                        <div class="response-text" id="response-box-2"></div>
                                    </div>
                                </div>
                                <div class="box-container">
                                    <div class="time-elapsed" id="response-time-3">Time elapsed: --</div>
                                    <div class="box">
                                        <div class="response-text" id="response-box-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="column right-column">
            <div class="terminal-container">
                <div class="terminal-header" id="agent1-name">Waiting for agent...</div>
                <div class="agent-properties" id="agent1-properties">
                    <div class="property-item">
                        <span class="property-label">Personality:</span>
                        <span class="property-value" id="agent1-personality">--</span>
                    </div>
                    <div class="property-item">
                        <span class="property-label">Tension Level:</span>
                        <span class="property-value" id="agent1-tension">0</span>
                    </div>
                    <div class="property-item">
                        <span class="property-label">Current Goal:</span>
                        <span class="property-value" id="agent1-goal">--</span>
                    </div>
                </div>
                <div id="agent1-pipeline"></div>
                <div class="terminal-content" id="agent1-terminal"></div>
            </div>
            <div class="terminal-container">
                <div class="terminal-header" id="agent2-name">Waiting for agent...</div>
                <div class="agent-properties" id="agent2-properties">
                    <div class="property-item">
                        <span class="property-label">Personality:</span>
                        <span class="property-value" id="agent2-personality">--</span>
                    </div>
                    <div class="property-item">
                        <span class="property-label">Tension Level:</span>
                        <span class="property-value" id="agent2-tension">0</span>
                    </div>
                    <div class="property-item">
                        <span class="property-label">Current Goal:</span>
                        <span class="property-value" id="agent2-goal">--</span>
                    </div>
                </div>
                <div id="agent2-pipeline"></div>
                <div class="terminal-content" id="agent2-terminal"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const promptBoxes = [
            document.getElementById('prompt-box-1'),
            document.getElementById('prompt-box-2'),
            document.getElementById('prompt-box-3')
        ];
        const promptTitles = [
            document.getElementById('prompt-title-1'),
            document.getElementById('prompt-title-2'),
            document.getElementById('prompt-title-3')
        ];
        const responseBoxes = [
            document.getElementById('response-box-1'),
            document.getElementById('response-box-2'),
            document.getElementById('response-box-3')
        ];
        const responseTimeDisplays = [
            document.getElementById('response-time-1'),
            document.getElementById('response-time-2'),
            document.getElementById('response-time-3')
        ];
        const agent1Name = document.getElementById('agent1-name');
        const agent2Name = document.getElementById('agent2-name');
        const agent1Terminal = document.getElementById('agent1-terminal');
        const agent2Terminal = document.getElementById('agent2-terminal');
        const agent1Pipeline = document.getElementById('agent1-pipeline');
        const agent2Pipeline = document.getElementById('agent2-pipeline');
        const agent1Personality = document.getElementById('agent1-personality');
        const agent2Personality = document.getElementById('agent2-personality');
        const agent1Tension = document.getElementById('agent1-tension');
        const agent2Tension = document.getElementById('agent2-tension');
        const agent1Goal = document.getElementById('agent1-goal');
        const agent2Goal = document.getElementById('agent2-goal');

        // Keep track of message history
        const agent1Messages = [];
        const agent2Messages = [];

        // Function to create pipeline flowchart
        function createPipelineFlow(agentId, components) {
            const pipelineContainer = document.createElement('div');
            pipelineContainer.className = 'pipeline-flow';

            components.forEach((component, index) => {
                const circle = document.createElement('div');
                circle.className = 'pipeline-circle';
                circle.id = `${agentId}-${component}`;
                circle.textContent = component;
                pipelineContainer.appendChild(circle);

                if (index < components.length - 1) {
                    const arrow = document.createElement('div');
                    arrow.className = 'pipeline-arrow';
                    arrow.textContent = 'â†’';
                    pipelineContainer.appendChild(arrow);
                }
            });

            const pipelineElement = agentId === 0 ? agent1Pipeline : agent2Pipeline;
            pipelineElement.innerHTML = ''; // Clear existing content
            pipelineElement.appendChild(pipelineContainer);
        }

        // Function to update pipeline stage
        function updatePipelineStage(agentId, stage) {
            // Remove active class from all circles for this agent
            const circles = document.querySelectorAll(`.pipeline-circle[id^="${agentId}-"]`);
            circles.forEach(circle => circle.classList.remove('active'));
            
            // Add active class to current stage
            const currentCircle = document.getElementById(`${agentId}-${stage}`);
            if (currentCircle) {
                currentCircle.classList.add('active');
            }
        }

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('initialize_agents', (data) => {
            if (data.agents && data.agents.length >= 2) {
                // Initialize agent 1
                if (data.agents[0]) {
                    agent1Name.textContent = data.agents[0].name || 'Agent 1';
                    agent1Personality.textContent = data.agents[0].personality || '--';
                    agent1Tension.textContent = data.agents[0].tension || 0;
                    agent1Goal.textContent = data.agents[0].current_goal || '--';
                    if (data.agents[0].components && Array.isArray(data.agents[0].components)) {
                        createPipelineFlow(0, data.agents[0].components);
                    }
                }
                
                // Initialize agent 2
                if (data.agents[1]) {
                    agent2Name.textContent = data.agents[1].name || 'Agent 2';
                    agent2Personality.textContent = data.agents[1].personality || '--';
                    agent2Tension.textContent = data.agents[1].tension || 0;
                    agent2Goal.textContent = data.agents[1].current_goal || '--';
                    if (data.agents[1].components && Array.isArray(data.agents[1].components)) {
                        createPipelineFlow(1, data.agents[1].components);
                    }
                }
            }
        });

        socket.on('config', (data) => {
            if (data.config && data.config.agents && data.config.agents.length >= 2) {
                agent1Name.textContent = data.config.agents[0].name;
                agent2Name.textContent = data.config.agents[1].name;
                agent1Personality.textContent = data.config.agents[0].personality || '--';
                agent2Personality.textContent = data.config.agents[1].personality || '--';
            }
        });

        socket.on('llm_interaction', (data) => {
            // Move content down to other boxes first
            promptBoxes[2].textContent = promptBoxes[1].textContent;
            promptTitles[2].textContent = promptTitles[1].textContent;
            responseBoxes[2].textContent = responseBoxes[1].textContent;
            responseTimeDisplays[2].textContent = responseTimeDisplays[1].textContent;
            
            promptBoxes[1].textContent = promptBoxes[0].textContent;
            promptTitles[1].textContent = promptTitles[0].textContent;
            responseBoxes[1].textContent = responseBoxes[0].textContent;
            responseTimeDisplays[1].textContent = responseTimeDisplays[0].textContent;
            
            // Add new content to first box
            promptBoxes[0].textContent = data.prompt || '';
            promptTitles[0].textContent = `Step: ${data.step_title || '--'}`;
            responseBoxes[0].textContent = data.response || '';
            responseTimeDisplays[0].textContent = `Time elapsed: ${data.elapsed_time || '--'}`;
        });

        socket.on('message', (data) => {
            if (data.sender_id === 0 || data.sender_id === 1) {
                const messages = data.sender_id === 0 ? agent1Messages : agent2Messages;
                const terminal = data.sender_id === 0 ? agent1Terminal : agent2Terminal;
                
                // Add new message to the beginning of the array
                messages.unshift(data.message);
                
                // Keep only the last 10 messages
                if (messages.length > 10) {
                    messages.pop();
                }
                
                // Update terminal content with messages in descending order
                terminal.textContent = messages.join('\n\n');
            }
        });

        // Listen for agent updates
        socket.on('update_agent1', (data) => {
            if (data.name) {
                agent1Name.textContent = data.name;
            }
            if (data.personality) {
                agent1Personality.textContent = data.personality;
            }
            if (data.tension !== undefined) {
                agent1Tension.textContent = data.tension;
            }
            if (data.plan?.goal) {
                agent1Goal.textContent = data.plan.goal;
            }
        });

        socket.on('update_agent2', (data) => {
            if (data.name) {
                agent2Name.textContent = data.name;
            }
            if (data.personality) {
                agent2Personality.textContent = data.personality;
            }
            if (data.tension !== undefined) {
                agent2Tension.textContent = data.tension;
            }
            if (data.plan?.goal) {
                agent2Goal.textContent = data.plan.goal;
            }
        });

        socket.on('pipeline_update', (data) => {
            const { agent_id, stage } = data;
            // Only update on stage start events (not completion)
            if (!stage.endsWith('_start')) {
                updatePipelineStage(agent_id, stage);
            }
        });
    </script>
</body>
</html>
